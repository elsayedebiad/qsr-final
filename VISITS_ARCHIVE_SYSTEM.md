# نظام أرشفة تقارير الزيارات 📦

## نظرة عامة

تم إضافة نظام متكامل لأرشفة تقارير الزيارات مع فلاتر متقدمة، مما يسمح بنقل الزيارات القديمة إلى الأرشيف وإدارتها بشكل منفصل.

---

## الميزات الرئيسية ✨

### 1. **أرشفة ذكية**
- ✅ أرشفة الزيارات المحددة
- ✅ أرشفة جميع الزيارات المفلترة دفعة واحدة
- ✅ أرشفة حسب الفلاتر (دولة، صفحة، تاريخ)
- ✅ حفظ تاريخ الأرشفة تلقائياً

### 2. **صفحة الأرشيف الكاملة**
- ✅ عرض جميع الزيارات المؤرشفة
- ✅ فلاتر متقدمة (دولة، صفحة، تاريخ)
- ✅ pagination (50 زيارة/صفحة)
- ✅ إحصائيات شاملة
- ✅ تصدير CSV
- ✅ حذف نهائي (Developer only)

### 3. **الفلاتر المتقدمة**
```
📍 الدولة: فلترة حسب دولة الزائر
🖱️ الصفحة: فلترة حسب صفحة المبيعات
📅 من تاريخ: البداية
📅 إلى تاريخ: النهاية
```

### 4. **صلاحيات الأمان**
- **ADMIN**: يمكنه أرشفة الزيارات
- **DEVELOPER**: يمكنه أرشفة + حذف نهائي

---

## البنية التقنية 🏗️

### 1. تحديث قاعدة البيانات

#### Schema Changes:
```prisma
model Visit {
  id              Int      @id @default(autoincrement())
  // ... الحقول الموجودة
  isArchived      Boolean  @default(false)  // جديد
  archivedAt      DateTime?                 // جديد
  
  @@index([isArchived])  // جديد
}
```

#### Migration:
```sql
-- prisma/migrations/20250124_add_visits_archive/migration.sql
ALTER TABLE "visits" 
  ADD COLUMN "isArchived" BOOLEAN NOT NULL DEFAULT false,
  ADD COLUMN "archivedAt" TIMESTAMP(3);

CREATE INDEX "visits_isArchived_idx" ON "visits"("isArchived");
```

### 2. API Endpoints

#### POST `/api/visits/archive`
أرشفة الزيارات

**Body:**
```json
{
  // خيار 1: أرشفة زيارات محددة
  "visitIds": [1, 2, 3],
  
  // خيار 2: أرشفة حسب الفلاتر
  "archiveAll": true,
  "filters": {
    "country": "Saudi Arabia",
    "targetPage": "sales1",
    "dateFrom": "2025-01-01",
    "dateTo": "2025-01-24"
  }
}
```

**Response:**
```json
{
  "success": true,
  "message": "تم أرشفة 150 زيارة",
  "archivedCount": 150
}
```

#### GET `/api/visits/archive`
جلب الزيارات المؤرشفة

**Query Parameters:**
```
?page=1
&limit=50
&country=Saudi+Arabia
&targetPage=sales1
&dateFrom=2025-01-01
&dateTo=2025-01-24
```

**Response:**
```json
{
  "success": true,
  "visits": [...],
  "pagination": {
    "page": 1,
    "limit": 50,
    "total": 500,
    "totalPages": 10
  },
  "stats": {
    "totalArchived": 500,
    "uniqueCountries": 15,
    "uniquePages": 11
  }
}
```

#### DELETE `/api/visits/archive`
حذف الزيارات المؤرشفة نهائياً (Developer only)

**Body:**
```json
{
  "deleteAll": true  // حذف جميع الزيارات المؤرشفة
}
```

**Response:**
```json
{
  "success": true,
  "message": "تم حذف 500 زيارة نهائياً",
  "deletedCount": 500
}
```

---

## صفحة التقارير المباشرة 📊

### الميزات الجديدة:

#### 1. أزرار الأرشفة:
```
┌─────────────────────────────────────────────────────┐
│  [📦 أرشفة المحدد (5)]  [📦 أرشفة الكل (50)]      │
│  [📦 الأرشيف]  [❌ إعادة تعيين]                   │
└─────────────────────────────────────────────────────┘
```

#### 2. صندوق اختيار (Checkbox):
- صندوق رئيسي في رأس الجدول (تحديد/إلغاء تحديد الكل)
- صندوق لكل زيارة في الجدول
- عداد الزيارات المحددة في العنوان

#### 3. الأزرار التفاعلية:

**أرشفة المحدد:**
```typescript
// يظهر فقط عند تحديد زيارات
// يطلب تأكيد قبل الأرشفة
// يعرض عدد الزيارات المحددة
```

**أرشفة الكل:**
```typescript
// يأرشف جميع الزيارات المفلترة
// يطلب تأكيد قبل الأرشفة
// يعمل مع الفلاتر النشطة
```

**الأرشيف:**
```typescript
// ينقل للصفحة الكاملة للأرشيف
// يفتح /dashboard/visits-archive
```

---

## صفحة الأرشيف 📦

### المسار:
```
/dashboard/visits-archive
```

### المكونات:

#### 1. Header
```
┌──────────────────────────────────────────────┐
│  📦 أرشيف تقارير الزيارات                   │
│  الزيارات المؤرشفة (500 زيارة)              │
│                                               │
│  [👁️ التقارير المباشرة]  [🔄 تحديث]         │
└──────────────────────────────────────────────┘
```

#### 2. بطاقات الإحصائيات
```
┌──────────────┬──────────────┬──────────────┐
│ 📦 500       │ 📍 15        │ 🖱️ 11       │
│ إجمالي       │ عدد الدول    │ عدد الصفحات  │
│ المؤرشف      │              │              │
└──────────────┴──────────────┴──────────────┘
```

#### 3. أدوات التحكم
```
┌────────────────────────────────────────────┐
│  [📥 تصدير CSV]  [🗑️ حذف الكل]           │
│  [❌ إعادة تعيين]                          │
└────────────────────────────────────────────┘
```

#### 4. الفلاتر
```
┌─────────────────────────────────────────────┐
│  [📍 الدولة]  [🖱️ الصفحة]                │
│  [📅 من تاريخ]  [📅 إلى تاريخ]            │
└─────────────────────────────────────────────┘
```

#### 5. جدول الزيارات
```
┌────────┬──────┬────────┬─────────┬────────┬────────┬──────────────┐
│ الوقت  │ IP   │ الدولة │ المدينة │ الصفحة │ المصدر │ تاريخ الأرشفة │
├────────┼──────┼────────┼─────────┼────────┼────────┼──────────────┤
│ ...    │ ...  │ ...    │ ...     │ ...    │ ...    │ ...          │
└────────┴──────┴────────┴─────────┴────────┴────────┴──────────────┘
```

#### 6. Pagination
```
┌──────────────────────────────────────────┐
│  صفحة 1 من 10 (500 زيارة)              │
│  [◄]  [►]                                │
└──────────────────────────────────────────┘
```

---

## حالات الاستخدام 🎯

### 1. أرشفة الزيارات القديمة
```typescript
// سيناريو: أرشفة زيارات العام الماضي
1. افتح صفحة التقارير المباشرة
2. حدد فلتر التاريخ: من 2024-01-01 إلى 2024-12-31
3. اضغط "أرشفة الكل"
4. تأكيد الأرشفة
→ يتم نقل جميع الزيارات المفلترة للأرشيف
```

### 2. أرشفة زيارات دولة معينة
```typescript
// سيناريو: أرشفة زيارات دولة محددة
1. حدد فلتر الدولة: Egypt
2. اضغط "أرشفة الكل"
3. تأكيد
→ جميع الزيارات من مصر تُنقل للأرشيف
```

### 3. أرشفة زيارات محددة
```typescript
// سيناريو: أرشفة زيارات معينة فقط
1. حدد الزيارات من الجدول (checkbox)
2. اضغط "أرشفة المحدد (5)"
3. تأكيد
→ الـ 5 زيارات المحددة تُنقل للأرشيف
```

### 4. مراجعة الزيارات المؤرشفة
```typescript
// سيناريو: مراجعة الأرشيف
1. اضغط زر "الأرشيف"
2. استخدم الفلاتر للبحث
3. راجع الزيارات المؤرشفة
4. صدّر CSV إذا لزم الأمر
```

### 5. حذف الأرشيف القديم (Developer)
```typescript
// سيناريو: تنظيف الأرشيف (Developer only)
1. افتح صفحة الأرشيف
2. راجع الإحصائيات
3. اضغط "حذف الكل"
4. تأكيد مرتين (عملية خطيرة!)
→ جميع الزيارات المؤرشفة تُحذف نهائياً
```

---

## الأمان 🔒

### التحقق من الصلاحيات:

#### في API:
```typescript
// 1. التحقق من تسجيل الدخول
const user = await verifyAuth(request)
if (!user) return 401

// 2. التحقق من الدور
if (!['ADMIN', 'DEVELOPER'].includes(user.role)) return 403

// 3. للحذف النهائي: Developer فقط
if (user.role !== 'DEVELOPER') return 403
```

#### في الواجهة:
```typescript
// القائمة الجانبية: adminOnly: true
{
  id: 'visits-archive',
  label: 'أرشيف تقارير الزيارات',
  icon: Archive,
  href: '/dashboard/visits-archive',
  adminOnly: true  // ✅
}
```

---

## تصدير البيانات 📥

### تصدير CSV:
```typescript
const exportToCSV = () => {
  const headers = [
    'ID', 'IP', 'الدولة', 'المدينة', 
    'الصفحة', 'المصدر', 'Google', 
    'تاريخ الزيارة', 'تاريخ الأرشفة'
  ]
  
  const rows = visits.map(v => [
    v.id,
    v.ipAddress,
    v.country || '-',
    v.city || '-',
    v.targetPage,
    v.utmSource || (v.isGoogle ? 'Google' : 'Direct'),
    v.isGoogle ? 'نعم' : 'لا',
    new Date(v.timestamp).toLocaleString('ar-EG'),
    new Date(v.archivedAt).toLocaleString('ar-EG')
  ])
  
  // تحويل لـ CSV وتنزيل
}
```

**اسم الملف:**
```
archived-visits-2025-01-24.csv
```

---

## الأداء ⚡

### التحسينات المطبقة:

#### 1. Indexes في DB:
```sql
CREATE INDEX "visits_isArchived_idx" ON "visits"("isArchived");
CREATE INDEX "visits_timestamp_idx" ON "visits"("timestamp");
CREATE INDEX "visits_targetPage_idx" ON "visits"("targetPage");
CREATE INDEX "visits_country_idx" ON "visits"("country");
```

#### 2. Pagination:
```typescript
// عرض 50 زيارة/صفحة فقط
take: 50,
skip: (page - 1) * 50
```

#### 3. Filtering في SQL:
```typescript
// الفلترة في قاعدة البيانات (لا في JavaScript)
where: {
  isArchived: true,
  country: countryFilter,
  targetPage: pageFilter,
  timestamp: { gte: dateFrom, lte: dateTo }
}
```

#### 4. Count منفصل:
```typescript
// حساب الإجمالي بشكل منفصل
const total = await db.visit.count({ where })
```

---

## الملفات المحدثة 📁

### 1. Schema:
```
✅ prisma/schema.prisma
✅ prisma/migrations/20250124_add_visits_archive/migration.sql
```

### 2. API:
```
✅ src/app/api/visits/archive/route.ts (جديد)
```

### 3. صفحات:
```
✅ src/app/dashboard/visits-report/page.tsx (محدث)
✅ src/app/dashboard/visits-archive/page.tsx (جديد)
```

### 4. مكونات:
```
✅ src/components/app-sidebar.tsx (محدث)
```

### 5. توثيق:
```
✅ VISITS_ARCHIVE_SYSTEM.md (هذا الملف)
```

---

## تشغيل Migration 🚀

### الخطوات:

1. **تطبيق Migration:**
```bash
npx prisma migrate deploy
```

2. **توليد Prisma Client:**
```bash
npx prisma generate
```

3. **التحقق من التطبيق:**
```bash
npx prisma studio
# تحقق من جدول visits - يجب أن يحتوي على isArchived و archivedAt
```

---

## الاختبار 🧪

### سيناريوهات الاختبار:

#### 1. أرشفة زيارة واحدة:
```
✅ تحديد زيارة واحدة
✅ أرشفتها
✅ التحقق من اختفائها من التقارير المباشرة
✅ التحقق من ظهورها في الأرشيف
```

#### 2. أرشفة متعددة:
```
✅ تحديد 10 زيارات
✅ أرشفتها دفعة واحدة
✅ التحقق من العدد الصحيح
```

#### 3. أرشفة حسب الفلاتر:
```
✅ تطبيق فلتر دولة
✅ أرشفة الكل
✅ التحقق من أرشفة الزيارات المفلترة فقط
```

#### 4. الفلاتر في الأرشيف:
```
✅ فلترة حسب الدولة
✅ فلترة حسب الصفحة
✅ فلترة حسب التاريخ
✅ فلترة مركبة (دولة + تاريخ)
```

#### 5. التصدير:
```
✅ تصدير CSV
✅ التحقق من البيانات
✅ التحقق من الترميز العربي
```

#### 6. الحذف النهائي (Developer):
```
✅ المحاولة كـ ADMIN → ممنوع
✅ المحاولة كـ DEVELOPER → مسموح
✅ التأكيد المزدوج
✅ الحذف النهائي
```

---

## الخلاصة 🎉

تم إنشاء نظام أرشفة متكامل يشمل:

✅ **أرشفة ذكية** - محددة أو جماعية أو حسب الفلاتر
✅ **صفحة أرشيف كاملة** - مع فلاتر وpagination
✅ **إحصائيات شاملة** - عدد المؤرشف، الدول، الصفحات
✅ **تصدير CSV** - لجميع البيانات المؤرشفة
✅ **حذف نهائي** - للـ Developer فقط
✅ **أمان عالي** - صلاحيات وتحقق متعدد
✅ **أداء محسّن** - indexes وpagination
✅ **واجهة جميلة** - تصميم احترافي ومتجاوب

النظام جاهز للاستخدام الفوري! 🚀
