# 👁️ دليل نظام تتبع الزيارات مع IP والدولة

## 🎯 نظرة عامة

نظام متقدم لتتبع جميع الزيارات مع تسجيل:
- ✅ **IP Address** - عنوان IP لكل زائر
- ✅ **الدولة** - تحديد تلقائي من IP
- ✅ **المدينة** - الموقع الدقيق
- ✅ **الصفحة المستهدفة** - أي صفحة مبيعات
- ✅ **المصدر** - Google, Facebook, Direct, إلخ
- ✅ **UTM Parameters** - تتبع الحملات
- ✅ **User Agent** - المتصفح والجهاز

---

## 📊 الصفحة الرئيسية

### الوصول:
```
http://localhost:3000/dashboard/visits
```

### المميزات:

#### 1. **بطاقات الإحصائيات**
- إجمالي الزيارات
- الزوار الفريدين (حسب IP)
- عدد الدول المختلفة
- عدد الصفحات المختلفة

#### 2. **أكثر الدول زيارة**
- ترتيب الدول حسب عدد الزيارات
- نسبة مئوية لكل دولة
- أعلام الدول 🇸🇦 🇪🇬 🇦🇪
- ميداليات للمراكز الثلاثة الأولى 🥇🥈🥉

#### 3. **جدول الزيارات المفصل**
يعرض لكل زيارة:
- ID فريد
- IP Address
- الدولة (مع العلم)
- المدينة
- الصفحة المستهدفة
- المصدر (Google 🔴 / Direct / UTM)
- الوقت والتاريخ

---

## 🔍 الفلاتر المتقدمة

### 1. **فلتر بالصفحة**
اختر صفحة معينة لرؤية زياراتها فقط:
```
Sales 1, Sales 2, ... Sales 11
```

### 2. **فلتر بالدولة**
اختر دولة لرؤية الزيارات منها فقط:
```
Saudi Arabia 🇸🇦
Egypt 🇪🇬
United Arab Emirates 🇦🇪
...
```

### 3. **فلتر بالتاريخ**
- **من تاريخ**: بداية الفترة
- **إلى تاريخ**: نهاية الفترة

مثال: عرض زيارات الأسبوع الماضي فقط

### 4. **إعادة التعيين**
زر لإزالة جميع الفلاتر والعودة لعرض الكل

---

## 📥 تصدير البيانات

### زر "تصدير CSV"
يصدر جميع الزيارات (مع الفلاتر المطبقة) لملف Excel:

**البيانات المُصدرة**:
```csv
ID, IP, الدولة, المدينة, الصفحة, المصدر, الوقت
1, 192.168.1.1, Saudi Arabia, Riyadh, /sales1, Google, 2025-01-24 01:30
2, 10.0.0.5, Egypt, Cairo, /sales2, Direct, 2025-01-24 01:45
...
```

**الاستخدام**:
1. طبّق الفلاتر المطلوبة (اختياري)
2. اضغط زر "تصدير CSV"
3. ستُحمّل الملف تلقائياً
4. افتحه بـ Excel

---

## 🌍 تحديد الدولة من IP

### API المستخدم: ipapi.co

**مجاني** حتى 1000 طلب/يوم

### كيف يعمل:
```javascript
// في /api/visits/track/route.ts
const geoResponse = await fetch(`https://ipapi.co/${ipAddress}/json/`)
const geoData = await geoResponse.json()

country = geoData.country_name  // "Saudi Arabia"
city = geoData.city             // "Riyadh"
```

### المعلومات المتوفرة:
- الدولة (الاسم الكامل)
- المدينة
- المنطقة/المحافظة
- الـ Timezone
- العملة
- اللغة

---

## 📊 الإحصائيات المتقدمة

### 1. **الزوار الفريدين**
عدد IPs مختلفة:
```sql
SELECT COUNT(DISTINCT ipAddress) FROM visits
```

### 2. **توزيع الدول**
أكثر 10 دول زيارة:
```sql
SELECT country, COUNT(*) as count
FROM visits
GROUP BY country
ORDER BY count DESC
LIMIT 10
```

### 3. **توزيع الصفحات**
أكثر صفحات زيارة:
```sql
SELECT targetPage, COUNT(*) as count
FROM visits
GROUP BY targetPage
ORDER BY count DESC
```

---

## 🎨 الأعلام المدعومة

### دول الخليج:
- 🇸🇦 السعودية
- 🇦🇪 الإمارات
- 🇰🇼 الكويت
- 🇶🇦 قطر
- 🇧🇭 البحرين
- 🇴🇲 عُمان

### دول عربية:
- 🇪🇬 مصر
- 🇯🇴 الأردن
- 🇱🇧 لبنان
- 🇮🇶 العراق

### دول أخرى:
- 🇺🇸 الولايات المتحدة
- 🇬🇧 بريطانيا
- 🌍 أخرى (افتراضي)

---

## 🔧 API Endpoints

### 1. تسجيل زيارة
```http
POST /api/visits/track

Body:
{
  "targetPage": "/sales1",
  "referer": "https://google.com",
  "utmSource": "google",
  "utmMedium": "cpc",
  "utmCampaign": "summer2025",
  "isGoogle": true,
  "userAgent": "Mozilla/5.0..."
}

Response:
{
  "success": true,
  "visitId": 123
}
```

### 2. جلب الزيارات
```http
GET /api/visits/list?page=1&limit=50&targetPage=/sales1&country=Saudi Arabia

Response:
{
  "success": true,
  "visits": [...],
  "pagination": {
    "page": 1,
    "limit": 50,
    "total": 150,
    "pages": 3
  },
  "stats": {
    "totalVisits": 150,
    "uniqueVisitors": 87,
    "countries": [...],
    "pages": [...]
  }
}
```

---

## 📈 حالات الاستخدام

### 1. **تتبع الحملات الإعلانية**
راقب من أين تأتي الزيارات:
```
- Google Ads: utm_source=google
- Facebook: utm_source=facebook
- Instagram: utm_source=instagram
```

### 2. **تحليل الأسواق**
حدد الدول الأكثر اهتماماً:
```
إذا وجدت 70% من السعودية
→ ركّز على إعلانات السعودية
```

### 3. **اختبار A/B**
قارن أداء صفحات المبيعات:
```
Sales 1: 500 زيارة
Sales 2: 300 زيارة
→ Sales 1 أكثر جذباً
```

### 4. **كشف الاحتيال**
راقب IPs مشبوهة:
```
نفس IP يزور 50 مرة في ساعة
→ احتمال bot
```

---

## 🚀 التكامل التلقائي

### في صفحة /sales:
الزيارة تُسجل تلقائياً عند الدخول:
```javascript
// في /sales/page.tsx
fetch('/api/visits/track', {
  method: 'POST',
  body: JSON.stringify({
    targetPage: target,  // مثلاً: /sales1
    referer,
    utmSource,
    isGoogle: isGoogleRef(referer)
  })
})
```

### في صفحات المبيعات الأخرى:
يمكن إضافة نفس الكود لتتبع زيارات مباشرة.

---

## 🔐 الخصوصية والأمان

### البيانات المحفوظة:
- ✅ IP (لإحصائيات فقط)
- ✅ الدولة/المدينة
- ❌ **لا نحفظ**:
  - الاسم الشخصي
  - البريد الإلكتروني
  - رقم الهاتف

### التوافق مع GDPR:
- IP يُستخدم للإحصائيات فقط
- لا نشارك البيانات مع أطراف ثالثة
- يمكن حذف البيانات عند الطلب

---

## 📱 Responsive Design

### Desktop:
- جدول كامل مع جميع الأعمدة
- 10 أعلام دول في صف واحد

### Tablet:
- جدول قابل للتمرير
- 5 أعلام في صف

### Mobile:
- تصميم بطاقات بدلاً من جدول
- علم دولة واحدة لكل بطاقة

---

## 🎯 أفضل الممارسات

### 1. **مراجعة يومية**
افتح صفحة الزيارات يومياً لمتابعة:
- عدد الزيارات الجديدة
- الدول الجديدة
- الصفحات الأكثر زيارة

### 2. **تحليل أسبوعي**
كل أسبوع:
- صدّر البيانات لـ CSV
- حلل الاتجاهات
- قارن مع الأسبوع السابق

### 3. **تحسين شهري**
كل شهر:
- حدد الصفحات الضعيفة
- حسّن المحتوى
- عدّل استراتيجية التسويق

---

## 🛠️ استكشاف الأخطاء

### مشكلة: الدولة تظهر "Unknown"
**السبب**: IP محلي (127.0.0.1) أو خطأ في API
**الحل**: 
```javascript
// في development، استخدم IP وهمي للاختبار
const testIP = '8.8.8.8'  // Google DNS
```

### مشكلة: بطء في التحميل
**السبب**: كثرة الزيارات
**الحل**:
- استخدم الفلاتر
- قلل عدد النتائج في الصفحة
- أضف Index على country و targetPage

### مشكلة: لا تظهر زيارات جديدة
**السبب**: خطأ في /api/visits/track
**الحل**:
- تحقق من console logs
- تأكد من صحة IP
- تحقق من قاعدة البيانات

---

## 📞 الدعم

### للمساعدة:
1. راجع سجلات الأخطاء (Console)
2. تحقق من قاعدة البيانات (Prisma Studio)
3. راجع API logs

---

## ✨ الخلاصة

**الآن لديك**:
- ✅ تتبع شامل للزيارات
- ✅ IP والدولة لكل زائر
- ✅ إحصائيات مفصلة
- ✅ فلاتر متقدمة
- ✅ تصدير CSV
- ✅ واجهة جميلة ومتجاوبة

**افتح الصفحة الآن**:
```
http://localhost:3000/dashboard/visits
```

🎉 **مبروك! نظام التتبع جاهز!**
