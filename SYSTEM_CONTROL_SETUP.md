# إعداد نظام التحكم في تفعيل/تعطيل النظام

## ✅ التحديثات المنفذة

### 1. فصل حالة النظام عن حساب المطور
- **المشكلة السابقة**: كان حساب المطور يتعطل عند تعطيل النظام
- **الحل**: تم إنشاء جدول `SystemSettings` منفصل لحفظ حالة النظام

### 2. إضافة زر التحكم في Sidebar
- تم إضافة زر تفعيل/إيقاف النظام في Sidebar للمطور فقط
- الزر يظهر باللون الأخضر عند التفعيل والأحمر عند التعطيل

### 3. تحسين صفحة إيقاف النظام
- تم تحديث صفحة `/payment-required` بثيم الداشبورد الحديث
- دعم الوضع الليلي (Dark Mode)

### 4. منع جميع المسارات عند التعطيل
- عند تعطيل النظام، جميع المستخدمين (ما عدا المطور) يتم توجيههم لصفحة الدفع
- المطور يمكنه الوصول لجميع الصفحات حتى لو كان النظام معطلاً

## 📋 خطوات التطبيق

### الخطوة 1: تحديث قاعدة البيانات

قم بتشغيل الأوامر التالية بالترتيب:

```bash
# 1. توليد Prisma Client
npx prisma generate

# 2. إنشاء Migration
npx prisma migrate dev --name add_system_settings

# أو إذا كنت تستخدم db push
npx prisma db push
```

### الخطوة 2: تهيئة إعدادات النظام

```bash
# تشغيل script لإنشاء السجل الافتراضي
node scripts/init-system-settings.js
```

### الخطوة 3: إعادة تشغيل السيرفر

```bash
npm run dev
```

## 🎯 كيفية الاستخدام

### للمطور:

1. **تسجيل الدخول** بحساب المطور (`developer@system.local`)
2. **في Sidebar** ستجد زر التحكم في النظام في الأسفل
3. **اضغط على الزر** للتبديل بين التفعيل والتعطيل

### حالات الاستخدام:

#### ✅ النظام مفعل (الحالة الافتراضية)
- جميع المستخدمين يمكنهم الوصول للنظام
- الزر في Sidebar يظهر باللون الأخضر: "النظام مفعل"

#### ❌ النظام معطل
- **المطور**: يمكنه الوصول لجميع الصفحات بشكل طبيعي
- **جميع المستخدمين الآخرين**: يتم توجيههم لصفحة `/payment-required`
- الزر في Sidebar يظهر باللون الأحمر: "النظام معطل"

## 🔧 الملفات المعدلة

### 1. Schema
- `prisma/schema.prisma` - إضافة جدول `SystemSettings`

### 2. API Routes
- `src/app/api/developer/toggle-system/route.ts` - تحديث لاستخدام `SystemSettings`
- `src/app/api/system-status/route.ts` - تحديث للتحقق من `SystemSettings`

### 3. Components
- `src/components/app-sidebar.tsx` - إضافة زر التحكم
- `src/components/SystemStatusChecker.tsx` - تحديث منطق التحقق

### 4. Pages
- `src/app/payment-required/page.tsx` - تحسين التصميم
- `src/app/developer-control/page.tsx` - تحديث لجلب الحالة من API

### 5. Scripts
- `scripts/init-system-settings.js` - script لتهيئة الإعدادات

## ⚠️ ملاحظات مهمة

1. **حساب المطور لا يتعطل أبداً** - حتى عند تعطيل النظام
2. **المطور فقط** يمكنه رؤية وتغيير حالة النظام
3. **جميع المستخدمين الآخرين** (بما فيهم ADMIN) يتأثرون بتعطيل النظام
4. **في حالة خطأ في API** - النظام يسمح بالوصول تلقائياً لتجنب التعطيل الكامل

## 🐛 استكشاف الأخطاء

### خطأ: Property 'systemSettings' does not exist

**الحل**: قم بتشغيل `npx prisma generate` لتوليد Prisma Client الجديد

### خطأ: EPERM operation not permitted

**الحل**: 
1. أغلق جميع نوافذ VS Code
2. أوقف جميع عمليات Node.js
3. شغل الأمر مرة أخرى

### النظام لا يتحقق من الحالة

**الحل**: تأكد من:
1. تشغيل `init-system-settings.js` لإنشاء السجل الافتراضي
2. إعادة تشغيل السيرفر
3. مسح cache المتصفح

## 📞 الدعم

في حالة وجود أي مشاكل، تحقق من:
- Console في المتصفح للأخطاء
- Terminal للأخطاء في السيرفر
- قاعدة البيانات للتأكد من وجود جدول `system_settings`
