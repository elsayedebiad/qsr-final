# 📊 دليل نظام التوزيع المرجح للزيارات

## 🎯 نظرة عامة

نظام التوزيع المرجح يوزع الزيارات القادمة إلى `/sales` على صفحات المبيعات المختلفة (sales1-sales11) بناءً على أوزان قابلة للتخصيص.

## ✅ كيف يعمل النظام بالضبط؟

### 1. التوزيع النسبي (Proportional Distribution)

النظام **لا يتطلب** أن يكون مجموع الأوزان = 100%. بدلاً من ذلك، يحسب النسب النسبية للأوزان المدخلة.

#### 🔢 أمثلة عملية:

**مثال 1: إذا أدخلت الأوزان [20, 30, 50]**
- المجموع = 100
- التوزيع الفعلي: 20%, 30%, 50% (بالضبط كما أدخلت)

**مثال 2: إذا أدخلت الأوزان [10, 10, 10]**
- المجموع = 30
- التوزيع الفعلي: 33.33%, 33.33%, 33.33%
- الحساب: 10/30 = 0.3333 لكل صفحة

**مثال 3: إذا أدخلت الأوزان [5, 15]**
- المجموع = 20
- التوزيع الفعلي: 25%, 75%
- الحساب: 5/20 = 25%, 15/20 = 75%

**مثال 4: إذا أدخلت الأوزان [1, 2, 3, 4]**
- المجموع = 10
- التوزيع الفعلي: 10%, 20%, 30%, 40%

### 2. قاعدة الصفر والتعطيل

#### ❌ إذا كتبت 0:
```
الوزن = 0 → الصفحة لن تظهر في التوزيع إطلاقاً
```
- لن تحصل الصفحة على أي زيارات من `/sales`
- الصفحة تُستثنى تماماً من قائمة التوزيع

#### ⚠️ إذا عملت تعطيل (isActive = false):
```
isActive = false → الصفحة مستثناة حتى لو كان لها وزن > 0
```
- حتى لو كان الوزن 50، الصفحة لن تستقبل زيارات

### 3. التوزيع المنفصل حسب المصدر

النظام يدعم توزيع مختلف حسب مصدر الزيارة:

#### 📊 Google Traffic (زيارات Google Ads/Search):
- يتم كشفها من `referrer` أو `gclid`
- تستخدم أوزان `googleWeight`
- يمكن تخصيص نسب مختلفة لكل صفحة

#### 🌍 Other Traffic (المصادر الأخرى):
- Facebook, Instagram, Direct, إلخ
- تستخدم أوزان `otherWeight`
- يمكن أن تختلف النسب عن Google

#### مثال:
```javascript
sales1: { googleWeight: 40, otherWeight: 10 }
sales2: { googleWeight: 30, otherWeight: 20 }
sales3: { googleWeight: 30, otherWeight: 70 }

// Google → التوزيع: 40%, 30%, 30%
// Other → التوزيع: 10%, 20%, 70%
```

## 🔧 كيفية الاستخدام

### 1. فتح صفحة التوزيع
```
/dashboard/distribution
```

### 2. تعديل الأوزان
- اكتب القيم المطلوبة في حقول Google و Other
- لا تقلق من المجموع - النظام يحسب النسب تلقائياً
- اكتب 0 لمنع صفحة من استقبال زيارات
- استخدم زر "تعطيل" لإيقاف صفحة مؤقتاً

### 3. معاينة التوزيع
- شاهد النسب الفعلية في قسم "معاينة التوزيع الفعلي"
- الأشرطة الملونة تظهر النسبة المئوية لكل صفحة

### 4. حفظ وتطبيق
- اضغط "حفظ التغييرات وتطبيقها فوراً"
- التطبيق فوري - لا يحتاج إعادة تشغيل

## 🧪 كيفية التحقق من التطبيق

### الطريقة الصحيحة للاختبار:

1. **افتح متصفح خاص (Incognito)**
   ```
   https://yoursite.com/sales
   ```

2. **أعد تحميل الصفحة 20-30 مرة**
   - استخدم Ctrl+Shift+R للتحديث
   - سجل الصفحة التي تظهر في كل مرة

3. **احسب النسب الفعلية**
   ```
   مثال: من 20 زيارة
   - sales1 ظهرت 8 مرات = 40%
   - sales2 ظهرت 6 مرات = 30%
   - sales3 ظهرت 6 مرات = 30%
   ```

4. **قارن مع الأوزان المحددة**
   - يجب أن تكون النسب قريبة جداً (±5%)
   - كلما زاد عدد الزيارات، كانت النتائج أدق

## 🔍 فهم Console Logs

عند فتح `/sales` في Developer Console، سترى:

```javascript
✅ Google distribution: Custom rules applied
📊 Active Distribution Rules:
  Google pages: ["/sales1 (40%)", "/sales2 (30%)", "/sales3 (30%)"]
  Total Google weight: 100.00%
  ℹ️ Note: If total ≠ 100%, distribution will be proportional

🎯 Distribution Result:
  Source: 📊 Google
  Selected page: /sales2
  Page weight: 30%
  Actual probability: 30.00%
  Random value: 42.37%
```

### شرح Logs:

- **Custom rules applied**: القواعد المخصصة تم تحميلها بنجاح
- **Active Distribution Rules**: الصفحات النشطة وأوزانها
- **Distribution Result**: النتيجة المختارة والنسب الفعلية

## ⚙️ التفاصيل التقنية

### الخوارزمية المستخدمة: Weighted Random Selection

```typescript
function pickWeighted(items, randomValue) {
  const total = items.reduce((s, i) => s + i.weight, 0)
  let cursor = randomValue * total
  
  for (const item of items) {
    cursor -= item.weight
    if (cursor <= 0) return item
  }
  
  return items[items.length - 1]
}
```

### كيف تعمل:
1. يحسب المجموع الكلي للأوزان
2. يولد رقم عشوائي من 0 إلى المجموع
3. يمر على الصفحات بالترتيب ويطرح الأوزان
4. أول صفحة تصل لـ 0 أو أقل = هي المختارة

### مثال:
```
الأوزان: [20, 30, 50]
المجموع: 100
رقم عشوائي: 0.65 (65%)

الحساب:
- cursor = 0.65 * 100 = 65
- sales1: 65 - 20 = 45 (لا تزال > 0)
- sales2: 45 - 30 = 15 (لا تزال > 0)
- sales3: 15 - 50 = -35 (< 0) ← المختارة!
```

## 🍪 Sticky Sessions (الثبات)

النظام يحفظ اختيار المستخدم في cookie لمدة 7 أيام:

```javascript
cookie: td_bucket = randomValue
expires: 7 days
```

**الفائدة:**
- إذا زار المستخدم نفس الصفحة مرة أخرى خلال 7 أيام
- سيتم توجيهه لنفس صفحة المبيعات
- يضمن تجربة متسقة

## 📝 الملفات الرئيسية

1. **`/src/app/sales/page.tsx`**
   - صفحة `/sales` التي تقوم بالتوزيع
   - تحتوي على منطق Weighted Random Selection

2. **`/src/app/dashboard/distribution/page.tsx`**
   - واجهة إدارة التوزيع
   - تعديل الأوزان والمعاينة

3. **`/src/app/api/distribution/rules/route.ts`**
   - API لحفظ وجلب القواعد
   - يحفظ في قاعدة البيانات

4. **`/src/middleware.ts`**
   - (اختياري) يمكن إضافة middleware للتوزيع

## ❓ أسئلة شائعة

### Q: هل يجب أن يكون المجموع = 100%؟
**A:** لا، النظام يحسب النسب النسبية تلقائياً.

### Q: ماذا لو كتبت أوزان كبيرة جداً (مثل 1000, 2000)؟
**A:** لا مشكلة، النظام سيحسب النسب (33.33%, 66.67%).

### Q: كيف أوقف صفحة مؤقتاً؟
**A:** استخدم زر "تعطيل" - أفضل من كتابة 0.

### Q: هل التطبيق فوري؟
**A:** نعم، بعد الحفظ مباشرة يتم تطبيق القواعد.

### Q: كيف أعرف أن النظام يعمل بشكل صحيح؟
**A:** اختبر في متصفح خاص 20-30 مرة وقارن النسب.

## 🚀 أفضل الممارسات

1. **ابدأ بتوزيع متساوي** (9.09 لكل صفحة)
2. **راقب الأداء** من صفحة الزيارات
3. **عدّل الأوزان** بناءً على معدلات التحويل
4. **اختبر دائماً** بعد أي تعديل
5. **استخدم التعطيل** للصفحات التي تحتاج صيانة

## 📊 مثال حقيقي

لنفترض أنك تريد:
- 60% من زيارات Google → sales1
- 40% من زيارات Google → sales2
- جميع زيارات Other → sales3

```javascript
sales1: { googleWeight: 60, otherWeight: 0, isActive: true }
sales2: { googleWeight: 40, otherWeight: 0, isActive: true }
sales3: { googleWeight: 0, otherWeight: 100, isActive: true }
```

النتيجة:
- ✅ Google → 60% sales1, 40% sales2
- ✅ Other → 100% sales3

## 🎓 الخلاصة

نظام التوزيع يعطيك تحكم كامل ودقيق في توزيع الزيارات:

✅ **أدخل القيم التي تريدها** - النظام يحسب النسب تلقائياً
✅ **القيمة 0 = تعطيل كامل** - لن تحصل الصفحة على أي زيارات
✅ **التعطيل يستثني الصفحة** - حتى لو كان لها وزن
✅ **التطبيق فوري** - لا يحتاج إعادة تشغيل
✅ **معاينة مباشرة** - شاهد النسب قبل التطبيق

---

**آخر تحديث:** 2024
**الإصدار:** 2.0
