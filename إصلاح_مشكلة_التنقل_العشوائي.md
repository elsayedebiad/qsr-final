# ุฅุตูุงุญ ูุดููุฉ ุงูุชููู ุงูุนุดูุงุฆู ูู ุตูุญุฉ ุงูุชูุงุฑูุฑ

## ๐ ุงููุดููุฉ

ุนูุฏ ุงูููุงู ุจุฃูุซุฑ ูู ุชููู ูุชุชุงูู ุจูู ุงูุตูุญุงุชุ ูุงู ุงููุธุงู "ูุฎุฑู" ููุณุชูุฑ ูู ุงูุชููู ุจุดูู ุนุดูุงุฆู ููุญุฏู ุจุฏูู ุชููู.

### ุงูุณุจุจ ุงูุฌุฐุฑู

ุงููุดููุฉ ูุงูุช ูู ุฅุฏุงุฑุฉ `useEffect` ู dependency arrays:

1. **ุงุณุชุฏุนุงุกุงุช ูุชุนุฏุฏุฉ ูู fetchStats**: ูุงู `fetchStats` ููุฌูุฏุงู ูู dependency array ูู useEffect
2. **ุชุนุงุฑุถ ุจูู useEffects**: ูุงู ููุงู ุชุนุงุฑุถ ุจูู useEffect ููุตูุญุฉ ู useEffect ููููุงุชุฑ
3. **re-renders ูุชูุฑุฑุฉ**: ูู ุชุบููุฑ ูุงู ูุคุฏู ูู re-render ุฌุฏูุฏ ูุณุชุฏุนู fetchStats ูุฑุฉ ุฃุฎุฑู
4. **ุนุฏู ูุฌูุฏ ุญูุงูุฉ ูู ุงูุทูุจุงุช ุงููุชุฒุงููุฉ**: ูู ููู ููุงู ุขููุฉ ูููุน ุงูุทูุจุงุช ุงููุชุนุฏุฏุฉ ุงููุชุฒุงููุฉ

---

## โ ุงูุญู ุงููุทุจู

### 1. ุงุณุชุฎุฏุงู fetchStatsInProgress Ref

```javascript
const fetchStatsInProgress = useRef(false)

const fetchStats = useCallback(async (page: number, resetToFirstPage = false) => {
  // ููุน ุงุณุชุฏุนุงุกุงุช ูุชุนุฏุฏุฉ ูุชุฒุงููุฉ
  if (fetchStatsInProgress.current) {
    return
  }
  
  fetchStatsInProgress.current = true
  
  try {
    // ... logic
  } finally {
    fetchStatsInProgress.current = false
  }
}, [countryFilter, pageFilter, campaignFilter, dateFrom, dateTo])
```

**ุงููุงุฆุฏุฉ**: ูููุน ุชูุงูุงู ุชูููุฐ ุนุฏุฉ ุทูุจุงุช ูู ููุณ ุงูููุช.

### 2. ุงุณุชุฎุฏุงู fetchStatsRef

```javascript
const fetchStatsRef = useRef(fetchStats)

useEffect(() => {
  fetchStatsRef.current = fetchStats
}, [fetchStats])
```

**ุงููุงุฆุฏุฉ**: ูุญุงูุธ ุนูู ูุฑุฌุน ุซุงุจุช ูู fetchStats ุฏูู ุงูุชุณุจุจ ูู re-renders.

### 3. ุชุจุณูุท useEffect ููุตูุญุงุช

**ูุจู ุงูุฅุตูุงุญ**:
```javascript
useEffect(() => {
  fetchStats(currentPage)
}, [currentPage, fetchStats])  // โ fetchStats ูู dependencies
```

**ุจุนุฏ ุงูุฅุตูุงุญ**:
```javascript
useEffect(() => {
  setIsNavigating(true)
  fetchStatsRef.current(currentPage)
}, [currentPage])  // โ ููุท currentPage
```

### 4. ูุตู useEffect ููููุงุชุฑ

**ูุจู ุงูุฅุตูุงุญ**:
```javascript
useEffect(() => {
  setCurrentPage(1)
  fetchStats(1)  // โ ุงุณุชุฏุนุงุก ูุฒุฏูุฌ
}, [filters])
```

**ุจุนุฏ ุงูุฅุตูุงุญ**:
```javascript
useEffect(() => {
  setCurrentPage(1)  // โ ููุท ุชุบููุฑ ุงูุตูุญุฉ
}, [filters])

// useEffect ูููุตู ูุชููู ุงูุชุญููู ุนูุฏ ุชุบููุฑ currentPage
useEffect(() => {
  setIsNavigating(true)
  fetchStatsRef.current(currentPage)
}, [currentPage])
```

### 5. ุชุญุฏูุซ ุฌููุน ุฃุฒุฑุงุฑ ุงูุชููู

**ูุจู ุงูุฅุตูุงุญ**:
```javascript
onClick={() => {
  setIsNavigating(true)
  fetchStats(currentPage + 1)  // โ ุงุณุชุฏุนุงุก ูุจุงุดุฑ
}}
```

**ุจุนุฏ ุงูุฅุตูุงุญ**:
```javascript
onClick={() => {
  if (!isNavigating) {
    setIsNavigating(true)
    setCurrentPage(prev => prev + 1)  // โ ุชุบููุฑ state ููุท
  }
}}
```

### 6. ุฅุตูุงุญ ุงูุชุญุฏูุซ ุงูุชููุงุฆู

```javascript
useEffect(() => {
  if (autoRefresh) {
    const interval = setInterval(() => {
      // ุงุณุชุฏุนุงุก ูุจุงุดุฑ ููู API ุจุฏูู ุชุบููุฑ ุงูู state
      fetch(`/api/visits/stats?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            setStats(data)
          }
        })
    }, 5000)
    return () => clearInterval(interval)
  }
}, [autoRefresh, filters])  // โ ูุง ูุนุชูุฏ ุนูู fetchStats
```

---

## ๐ ุงูููุงุฆุฏ

### 1. ุงุณุชูุฑุงุฑ ูุงูู
- โ ูุง ูุฒูุฏ ูู ุงูุชููู ุงูุนุดูุงุฆู
- โ ูู ููุฑุฉ ุชุคุฏู ูุงูุชูุงู ูุงุญุฏ ููุท
- โ ูุง ุชุนุงุฑุถ ุจูู ุงูุนูููุงุช

### 2. ุฃุฏุงุก ูุญุณูู
- โก ุนุฏุฏ ุฃูู ูู ุงูุทูุจุงุช ููู API
- โก re-renders ุฃูู
- โก ุงุณุชุฌุงุจุฉ ุฃุณุฑุน

### 3. ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู
- ๐ฏ ุชููู ุฏููู ูุณูุณ
- ๐ฏ ุฒุฑ ุงูุชุญููู ูุฏูุฑ ููุท ุฃุซูุงุก ุงูุชุญููู ุงููุนูู
- ๐ฏ ูุง ุชููู ุฃู ุชุฃุฎูุฑ ุบูุฑ ูุชููุน

---

## ๐ ููู ูุนูู ุงููุธุงู ุงูุขูุ

### ุณููุงุฑูู 1: ุงูููุฑ ุนูู ุฒุฑ "ุงูุชุงูู"

```
1. ุงููุณุชุฎุฏู ูููุฑ "ุงูุชุงูู"
   โ
2. if (!isNavigating) โ true
   โ
3. setIsNavigating(true)
   โ
4. setCurrentPage(prev => prev + 1)
   โ
5. useEffect ููุชุดู ุชุบููุฑ currentPage
   โ
6. fetchStatsRef.current(newPage)
   โ
7. fetchStats ูุชุญูู ูู fetchStatsInProgress.current
   โ
8. ุฅุฐุง false โ ูุจุฏุฃ ุงูุชุญููู
   โ
9. fetchStatsInProgress.current = true
   โ
10. ุงุณุชุฏุนุงุก API
   โ
11. ุชุญุฏูุซ stats
   โ
12. finally: setIsNavigating(false) + fetchStatsInProgress.current = false
```

### ุณููุงุฑูู 2: ููุฑุงุช ุณุฑูุนุฉ ูุชุนุฏุฏุฉ

```
1. ุงูููุฑุฉ ุงูุฃููู:
   - isNavigating = false โ ููุฑ
   - ูุจุฏุฃ ุงูุชุญููู
   - isNavigating = true
   
2. ุงูููุฑุฉ ุงูุซุงููุฉ (ุจุณุฑุนุฉ):
   - isNavigating = true โ ูุชู ุชุฌุงูููุง โ
   
3. ุงูููุฑุฉ ุงูุซุงูุซุฉ (ุจุณุฑุนุฉ):
   - isNavigating = true โ ูุชู ุชุฌุงูููุง โ
   
4. ุงูุชูุงุก ุงูุชุญููู ุงูุฃูู:
   - isNavigating = false
   - ุงููุธุงู ุฌุงูุฒ ููููุฑุฉ ุงูุชุงููุฉ
```

### ุณููุงุฑูู 3: ุชุบููุฑ ุงูููุงุชุฑ

```
1. ุงููุณุชุฎุฏู ูุบูุฑ ููุชุฑ ุงูุฏููุฉ
   โ
2. useEffect ููููุงุชุฑ ูุชู ุชูุนููู
   โ
3. setCurrentPage(1)
   โ
4. useEffect ููุตูุญุฉ ููุชุดู ุงูุชุบููุฑ
   โ
5. ูุญูู ุงูุจูุงูุงุช ููุตูุญุฉ 1 ูุน ุงูููุชุฑ ุงูุฌุฏูุฏ
   โ
6. ูุง ุงุณุชุฏุนุงุก ูุฒุฏูุฌ โ
```

---

## ๐ ุงูุญูุงูุฉ ูู ุงูุฃุฎุทุงุก

### 1. ุญูุงูุฉ ูู ุงูููุฑุงุช ุงููุชุนุฏุฏุฉ
```javascript
if (!isNavigating) {
  // ููุท ุฅุฐุง ูู ููู ููุงู ุชุญููู ุฌุงุฑู
}
```

### 2. ุญูุงูุฉ ูู ุงูุทูุจุงุช ุงููุชุฒุงููุฉ
```javascript
if (fetchStatsInProgress.current) {
  return  // ููุน ุงูุทูุจ ุงูุฌุฏูุฏ
}
```

### 3. ุญูุงูุฉ ูู ุงูุชุญุฏูุซ ุงูุชููุงุฆู ุงููุชุฏุงุฎู
```javascript
// ุงูุชุญุฏูุซ ุงูุชููุงุฆู ูุง ูุณุชุฎุฏู fetchStats
// ุงุณุชุฏุนุงุก ูุจุงุดุฑ ููู API
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

ุชู ุงุฎุชุจุงุฑ ุงูุณููุงุฑูููุงุช ุงูุชุงููุฉ:

- โ ุงูููุฑ ุงูุณุฑูุน ุงููุชูุฑุฑ ุนูู "ุงูุชุงูู"
- โ ุงูููุฑ ุงูุณุฑูุน ุงููุชูุฑุฑ ุนูู "ุงูุณุงุจู"
- โ ุงูููุฒ ูุตูุญุฉ ูุญุฏุฏุฉ ูุน ููุฑุงุช ุณุฑูุนุฉ
- โ ุงุณุชุฎุฏุงู ุงุฎุชุตุงุฑุงุช ููุญุฉ ุงูููุงุชูุญ ุจุณุฑุนุฉ
- โ ุชุบููุฑ ุงูููุงุชุฑ ุฃุซูุงุก ุงูุชุญููู
- โ ุงูุชุญุฏูุซ ุงูุชููุงุฆู ูุง ูุชุนุงุฑุถ ูุน ุงูุชููู ุงููุฏูู
- โ ุชุบููุฑ ุนุฏุฏ ุงูุนูุงุตุฑ ูู ุงูุตูุญุฉ

---

## ๐ ุงูููุงุญุธุงุช ุงููููุฉ

### Dependencies ูู useCallback

```javascript
// โ ุงูุตุญูุญ
const fetchStats = useCallback(async (page: number) => {
  // ...
}, [countryFilter, pageFilter, campaignFilter, dateFrom, dateTo])

// โ ุงูุฎุงุทุฆ (ูุณุจุจ re-renders)
const fetchStats = useCallback(async (page: number) => {
  // ...
}, [countryFilter, pageFilter, campaignFilter, dateFrom, dateTo, isNavigating, fetchStats])
```

### ุงุณุชุฎุฏุงู useRef vs useState

- **useRef**: ููููู ุงูุชู ูุง ุชุญุชุงุฌ re-render (ูุซู fetchStatsInProgress)
- **useState**: ููููู ุงูุชู ุชุคุซุฑ ุนูู UI (ูุซู isNavigating)

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุงููุธุงู ุงูุขู ูุนูู ุจุดูู:
- โก **ุณูุณ**: ูุง ุชููู ุฃู ุชุฃุฎูุฑ
- ๐ฏ **ุฏููู**: ูู ููุฑุฉ = ุงูุชูุงู ูุงุญุฏ
- ๐ **ุขูู**: ูุญูู ูู ุงูุฃุฎุทุงุก
- ๐ฑ **ููุซูู**: ูุนูู ูู ุฌููุน ุงูุณููุงุฑูููุงุช

---

## ๐ง ุงููููุงุช ุงููุนุฏูุฉ

- `src/app/dashboard/visits-report/page.tsx`

### ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ:
1. ุฅุถุงูุฉ `fetchStatsInProgress` ref
2. ุฅุถุงูุฉ `fetchStatsRef` ref
3. ุชุจุณูุท ุฌููุน useEffect
4. ุชุญุฏูุซ ุฌููุน ุฃุฒุฑุงุฑ ุงูุชููู
5. ูุตู ุงูุชุญุฏูุซ ุงูุชููุงุฆู ุนู fetchStats

---

ุชู ุงูุฅุตูุงุญ ุจูุฌุงุญ! โ
ุงูุชุงุฑูุฎ: 2025-10-25

