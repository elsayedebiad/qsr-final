generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int                    @id @default(autoincrement())
  email                 String                 @unique
  name                  String
  password              String
  role                  Role                   @default(USER)
  permissions           String[]               @default([])
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  activities            ActivityLog[]
  bookedCVs             Booking[]              @relation("BookedCVs")
  createdCVs            CV[]                   @relation("CVCreatedBy")
  updatedCVs            CV[]                   @relation("CVUpdatedBy")
  createdContracts      Contract[]             @relation("ContractCreatedBy")
  notifications         Notification[]
  sessions              Session[]
  loginActivations      LoginActivation[]
  userSessions          UserSession[]          @relation("UserSessions")
  assignedDistributions CVDistribution[]       @relation("DistributionAssigner")
  removedDistributions  CVDistribution[]       @relation("DistributionRemover")
  distributionLogs      DistributionLog[]
  contractStatusChanges ContractStatusChange[] @relation("ContractStatusChangedBy")
  createdNewContracts   NewContract[]          @relation("NewContractCreatedBy")
  followUpNotes         FollowUpNote[]         @relation("FollowUpNoteCreatedBy")
  assignedSalesPages    UserSalesPage[]        @relation("UserSalesPageAssignments")

  @@map("users")
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model CV {
  id                 Int              @id @default(autoincrement())
  fullName           String
  fullNameArabic     String?
  email              String?
  phone              String?
  referenceCode      String?          @unique
  monthlySalary      String?
  contractPeriod     String?
  position           String?
  passportNumber     String?          @unique
  passportIssueDate  String?
  passportExpiryDate String?
  passportIssuePlace String?
  nationality        String?
  religion           String?
  dateOfBirth        String?
  placeOfBirth       String?
  livingTown         String?
  maritalStatus      MaritalStatus?
  numberOfChildren   Int?
  weight             String?
  height             String?
  complexion         String?
  age                Int?
  englishLevel       SkillLevel?
  arabicLevel        SkillLevel?
  englishLevelRaw    String? // القيمة الأصلية من الشيت
  arabicLevelRaw     String? // القيمة الأصلية من الشيت
  babySitting        SkillLevel?
  childrenCare       SkillLevel?
  tutoring           SkillLevel?
  disabledCare       SkillLevel?
  cleaning           SkillLevel?
  washing            SkillLevel?
  ironing            SkillLevel?
  arabicCooking      SkillLevel?
  sewing             SkillLevel?
  driving            SkillLevel?
  previousEmployment String?
  profileImage       String?
  cvImageUrl         String? // رابط صورة السيرة الكاملة المصممة
  videoLink          String?
  experience         String?
  education          String?
  skills             String?
  summary            String?
  content            String?
  notes              String?
  attachments        String?
  status             CVStatus         @default(NEW)
  priority           Priority         @default(MEDIUM)
  source             String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  createdById        Int
  updatedById        Int?
  cooking            SkillLevel?
  educationLevel     String?
  elderCare          SkillLevel?
  housekeeping       SkillLevel?
  activities         ActivityLog[]
  booking            Booking?
  contract           Contract?
  versions           CVVersion[]
  createdBy          User             @relation("CVCreatedBy", fields: [createdById], references: [id])
  updatedBy          User?            @relation("CVUpdatedBy", fields: [updatedById], references: [id])
  distributions      CVDistribution[]
  newContracts       NewContract[]    @relation("NewContractCV")

  @@map("cvs")
}

model CVVersion {
  id        Int      @id @default(autoincrement())
  cvId      Int
  content   String
  version   Int
  createdAt DateTime @default(now())
  createdBy Int
  cv        CV       @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@unique([cvId, version])
  @@map("cv_versions")
}

model Booking {
  id             Int      @id @default(autoincrement())
  cvId           Int      @unique
  identityNumber String
  notes          String?
  bookedAt       DateTime @default(now())
  bookedById     Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  bookedBy       User     @relation("BookedCVs", fields: [bookedById], references: [id])
  cv             CV       @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("bookings")
}

model Contract {
  id                Int       @id @default(autoincrement())
  cvId              Int       @unique
  identityNumber    String
  contractStartDate DateTime  @default(now())
  contractEndDate   DateTime?
  createdById       Int?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  cv                CV        @relation(fields: [cvId], references: [id], onDelete: Cascade)
  createdBy         User?     @relation("ContractCreatedBy", fields: [createdById], references: [id])

  @@map("contracts")
}

model Notification {
  id        Int              @id @default(autoincrement())
  title     String
  message   String
  type      NotificationType
  category  String
  data      String?
  isRead    Boolean          @default(false)
  userId    Int
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  cvId        Int?
  action      String
  description String
  metadata    Json?
  targetType  String?
  targetId    String?
  targetName  String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  cv          CV?      @relation(fields: [cvId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model SalesConfig {
  id             String   @id @default(cuid())
  salesPageId    String   @unique
  whatsappNumber String   @default("")
  hideFilters    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("sales_configs")
}

model Banner {
  id          Int        @id @default(autoincrement())
  salesPageId String // sales1, sales2, sales3, sales4
  imageUrl    String     @db.Text // الصورة كـ Base64 (محفوظة في قاعدة البيانات)
  deviceType  DeviceType // mobile أو desktop
  bannerType  BannerType @default(MAIN) // نوع البنر: رئيسي أو إضافي
  order       Int        @default(0) // ترتيب البنر
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("banners")
}

model LoginActivation {
  id             Int      @id @default(autoincrement())
  userId         Int
  activationCode String   @unique
  isUsed         Boolean  @default(false)
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_activations")
}

model SystemSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique // مفتاح الإعداد (مثل: "system_active")
  value     String // قيمة الإعداد
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model UserSession {
  id           Int       @id @default(autoincrement())
  userId       Int
  sessionId    String    @unique
  loginTime    DateTime  @default(now())
  logoutTime   DateTime?
  lastActivity DateTime  @default(now())
  ipAddress    String?
  userAgent    String?
  isActive     Boolean   @default(true)
  duration     Int? // Session duration in minutes
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

enum DeviceType {
  MOBILE
  DESKTOP
}

enum BannerType {
  MAIN
  SECONDARY
}

enum Role {
  DEVELOPER
  ADMIN
  SUB_ADMIN
  CUSTOMER_SERVICE
  SALES
  USER
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum CVStatus {
  NEW
  BOOKED
  HIRED
  REJECTED
  RETURNED
  ARCHIVED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum SkillLevel {
  YES
  NO
  WILLING
}

enum ActivityType {
  CV_CREATED
  CV_UPDATED
  CV_DELETED
  CV_STATUS_CHANGED
  CV_EXPORTED
  USER_LOGIN
  USER_LOGOUT
  EXCEL_IMPORT
  CV_DISTRIBUTED
  CV_REMOVED_FROM_PAGE
}

// نظام التوزيع الجديد
model CVDistribution {
  id          Int       @id @default(autoincrement())
  cvId        Int
  salesPageId String // sales1, sales2, ... sales11
  assignedAt  DateTime  @default(now())
  removedAt   DateTime?
  isActive    Boolean   @default(true)
  assignedBy  Int
  removedBy   Int?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  cv       CV    @relation(fields: [cvId], references: [id], onDelete: Cascade)
  assigner User  @relation("DistributionAssigner", fields: [assignedBy], references: [id])
  remover  User? @relation("DistributionRemover", fields: [removedBy], references: [id])

  @@unique([cvId, salesPageId, isActive])
  @@index([salesPageId, isActive])
  @@index([cvId])
  @@map("cv_distributions")
}

model DistributionRule {
  id             Int      @id @default(autoincrement())
  salesPageId    String   @unique
  dailyLimit     Int? // حد السير اليومية (null = لا يوجد حد)
  totalLimit     Int? // الحد الأقصى الكلي
  minCVs         Int      @default(0) // الحد الأدنى
  maxCVs         Int? // الحد الأقصى
  priority       Int      @default(0) // أولوية الصفحة في التوزيع
  isActive       Boolean  @default(true)
  autoDistribute Boolean  @default(false) // التوزيع التلقائي
  nationality    String? // تخصيص لجنسية معينة
  position       String? // تخصيص لوظيفة معينة
  googleWeight   Float    @default(0) // نسبة التوزيع لزيارات Google
  otherWeight    Float    @default(0) // نسبة التوزيع لباقي الزيارات
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("distribution_rules")
}

model DistributionLog {
  id          Int      @id @default(autoincrement())
  action      String // ASSIGNED, REMOVED, BULK_ASSIGNED, etc.
  salesPageId String
  cvIds       Int[] // قائمة معرفات السير
  userId      Int
  count       Int // عدد السير المتأثرة
  details     Json? // تفاصيل إضافية
  timestamp   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([salesPageId, timestamp])
  @@map("distribution_logs")
}

// إحصائيات التوزيع
model DistributionStats {
  id            Int      @id @default(autoincrement())
  salesPageId   String
  date          DateTime @db.Date
  totalAssigned Int      @default(0)
  totalRemoved  Int      @default(0)
  activeCount   Int      @default(0)
  viewCount     Int      @default(0)
  bookingCount  Int      @default(0)
  contractCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([salesPageId, date])
  @@index([salesPageId])
  @@index([date])
  @@map("distribution_stats")
}

// تتبع الزيارات
model Visit {
  id          Int       @id @default(autoincrement())
  ipAddress   String
  country     String?
  city        String?
  userAgent   String?
  referer     String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  targetPage  String // الصفحة التي تم التوجيه إليها
  isGoogle    Boolean   @default(false)
  isArchived  Boolean   @default(false) // للأرشفة
  archivedAt  DateTime? // تاريخ الأرشفة
  timestamp   DateTime  @default(now())

  // معلومات الحملات الإعلانية
  gclid   String? // Google Click ID
  fbclid  String? // Facebook Click ID
  msclkid String? // Microsoft/Bing Click ID
  ttclid  String? // TikTok Click ID

  // معلومات الجهاز والمتصفح
  device         String? // mobile, desktop, tablet
  browser        String? // Chrome, Safari, Firefox, etc.
  os             String? // Windows, macOS, iOS, Android, etc.
  browserVersion String? // إصدار المتصفح
  osVersion      String? // إصدار نظام التشغيل

  // معلومات إضافية
  screenWidth  Int? // عرض الشاشة
  screenHeight Int? // ارتفاع الشاشة
  language     String? // لغة المتصفح
  timezone     String? // المنطقة الزمنية

  @@index([timestamp])
  @@index([targetPage])
  @@index([country])
  @@index([utmSource])
  @@index([isArchived])
  @@index([gclid])
  @@index([fbclid])
  @@index([device])
  @@map("visits")
}

// نظام العقود الجديد
model NewContract {
  id                    Int               @id @default(autoincrement())
  contractType          ContractType // نوع العقد
  salesRepName          String // اسم ممثل المبيعات
  clientName            String // اسم العميل
  contractNumber        String            @unique // رقم العقد
  supportMobileNumber   String? // رقم الجوال المساند
  salesMobileNumber     String? // رقم المبيعات
  currentMonth          Int // رقم الشهر الميلادي
  currentDate           DateTime          @default(now()) // التاريخ الحالي
  countryName           String // اسم الدولة
  profession            String // المهنة
  employerIdNumber      String // رقم هوية صاحب العمل
  workerPassportNumber  String // رقم جواز العاملة
  cvId                  Int? // ربط مع السيرة الذاتية
  office                String // المكتب المختار
  status                NewContractStatus @default(CV_REQUEST) // الحالة
  statusHistory         Json? // تاريخ الحالات
  lastStatusUpdate      DateTime          @default(now()) // آخر تحديث للحالة
  cvUploadRequestDate   DateTime? // تاريخ طلب رفع السيرة
  employmentRequestDate DateTime? // تاريخ طلب التوظيف
  followUpNotes         String? // ملاحظات المتابعة
  hasCVIssue            Boolean           @default(false) // وجود مشكلة في السيرة
  cvIssueType           String? // نوع المشكلة (تبديل / توثيق)
  createdById           Int // الموظف المنشئ
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  statusChanges        ContractStatusChange[] // سجل تغييرات الحالة
  followUpNotesHistory FollowUpNote[] // سجل ملاحظات المتابعة
  cv                   CV?                    @relation("NewContractCV", fields: [cvId], references: [id])
  createdBy            User                   @relation("NewContractCreatedBy", fields: [createdById], references: [id])

  @@index([contractNumber])
  @@index([status])
  @@index([createdById])
  @@index([cvId])
  @@index([workerPassportNumber])
  @@map("new_contracts")
}

// سجل تغييرات حالة العقد
model ContractStatusChange {
  id          Int                @id @default(autoincrement())
  contractId  Int
  fromStatus  NewContractStatus?
  toStatus    NewContractStatus
  changedAt   DateTime           @default(now())
  changedById Int
  notes       String?

  contract  NewContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  changedBy User        @relation("ContractStatusChangedBy", fields: [changedById], references: [id])

  @@index([contractId])
  @@index([changedById])
  @@map("contract_status_changes")
}

// سجل ملاحظات المتابعة
model FollowUpNote {
  id          Int      @id @default(autoincrement())
  contractId  Int
  note        String   @db.Text
  createdById Int
  createdAt   DateTime @default(now())

  contract  NewContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  createdBy User        @relation("FollowUpNoteCreatedBy", fields: [createdById], references: [id])

  @@index([contractId])
  @@index([createdById])
  @@map("follow_up_notes")
}

// قائمة ممثلي المبيعات (قابلة للتعديل)
model SalesRepresentative {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sales_representatives")
}

// تخصيص صفحات المبيعات للمستخدمين
model UserSalesPage {
  id          Int      @id @default(autoincrement())
  userId      Int
  salesPageId String // sales1, sales2, sales3, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation("UserSalesPageAssignments", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, salesPageId])
  @@index([userId])
  @@index([salesPageId])
  @@map("user_sales_pages")
}

enum ContractType {
  SPECIFIC // معين
  BY_SPECIFICATIONS // حسب المواصفات
}

enum NewContractStatus {
  CV_REQUEST // طلب رفع سيرة
  EXTERNAL_OFFICE_APPROVAL // موافقة مكتب الإرسال الخارجي
  FOREIGN_MINISTRY_APPROVAL // موافقة وزارة العمل الأجنبية
  VISA_ISSUED // تم إصدار التأشيرة
  EMBASSY_SENT // تم الإرسال للسفارة السعودية
  EMBASSY_APPROVAL // وصل للمملكة العربية السعودية
  TICKET_DATE_NOTIFIED // تم التبليغ بموعد التذكرة
  REJECTED // مرفوض
  CANCELLED // ملغي
  OUTSIDE_KINGDOM // خارج المملكة
}

// تتبع عمليات البحث والفلاتر
model SearchAnalytics {
  id            Int      @id @default(autoincrement())
  salesPageId   String // sales1, sales2, ... sales11
  searchTerm    String? // كلمة البحث
  nationality   String? // فلتر الجنسية
  position      String? // فلتر الوظيفة
  ageFilter     String? // فلتر العمر
  experience    String? // فلتر الخبرة
  arabicLevel   String? // فلتر اللغة العربية
  englishLevel  String? // فلتر اللغة الإنجليزية
  maritalStatus String? // فلتر الحالة الاجتماعية
  skills        String[] @default([]) // المهارات المحددة
  religion      String? // فلتر الديانة
  education     String? // فلتر التعليم
  ipAddress     String? // عنوان IP
  userAgent     String? // معلومات المتصفح
  sessionId     String? // معرف الجلسة
  resultsCount  Int? // عدد النتائج
  timestamp     DateTime @default(now())

  @@index([salesPageId, timestamp])
  @@index([searchTerm])
  @@index([nationality])
  @@index([position])
  @@map("search_analytics")
}

// تتبع نقرات زر الحجز والاستفسار
model BookingClick {
  id          Int      @id @default(autoincrement())
  salesPageId String // sales1, sales2, ... sales11
  cvId        String? // معرف السيرة الذاتية
  cvName      String? // اسم السيرة الذاتية
  action      String   @default("BOOKING_CLICK") // BOOKING_CLICK, WHATSAPP_SENT, PHONE_CALL
  userAgent   String? // معلومات المتصفح
  ipAddress   String? // عنوان IP
  deviceType  String? // MOBILE or DESKTOP
  messageSent Boolean  @default(false) // هل تم إرسال الرسالة أم لا
  createdAt   DateTime @default(now())

  @@index([salesPageId])
  @@index([createdAt])
  @@index([messageSent])
  @@map("booking_clicks")
}

// جمع أرقام الهواتف من صفحات المبيعات
model PhoneNumber {
  id           Int       @id @default(autoincrement())
  phoneNumber  String
  salesPageId  String // الصفحة التي تم جمع الرقم منها
  source       String? // مصدر الزائر (google, facebook, direct, etc.)
  ipAddress    String? // عنوان IP للزائر
  userAgent    String? // معلومات المتصفح
  deviceType   String? // MOBILE or DESKTOP
  country      String? // الدولة
  city         String? // المدينة
  notes        String? // ملاحظات إضافية
  isArchived   Boolean   @default(false) // للأرشفة
  isContacted  Boolean   @default(false) // هل تم التواصل عبر واتساب
  contactedAt  DateTime? // تاريخ التواصل
  createdAt    DateTime  @default(now())

  @@index([salesPageId])
  @@index([createdAt])
  @@index([isArchived])
  @@index([phoneNumber])
  @@index([isContacted])
  @@map("phone_numbers")
}
