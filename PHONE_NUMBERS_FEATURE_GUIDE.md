# نظام جمع أرقام الهواتف من صفحات المبيعات

## نظرة عامة
تم إضافة نظام احترافي لجمع أرقام الهواتف من العملاء في صفحات المبيعات مع لوحة تحكم متكاملة لإدارتها.

## المميزات

### 1. نافذة منبثقة احترافية
- **تصميم احترافي**: متناسق مع ثيم الداشبورد
- **غير إجبارية**: يمكن للمستخدم إغلاقها بسهولة
- **تأخير ذكي**: تظهر بعد 8 ثوان من دخول الصفحة
- **عدم التكرار**: لا تظهر مرة أخرى لنفس المستخدم لمدة 7 أيام
- **رسالة تحفيزية**: "احصل على عروض حصرية"
- **حماية البيانات**: رسالة توضح أمان المعلومات

### 2. تتبع شامل للبيانات
يتم حفظ المعلومات التالية مع كل رقم:
- رقم الهاتف
- الصفحة المصدر (sales1, sales2, إلخ)
- مصدر الزيارة (Google, Facebook, Direct, إلخ)
- عنوان IP
- نوع الجهاز (Mobile/Desktop)
- الموقع الجغرافي (الدولة والمدينة)
- تاريخ ووقت الإدخال
- معلومات المتصفح

### 3. لوحة تحكم متكاملة
- **إحصائيات**: عرض عدد الأرقام لكل صفحة مبيعات
- **تصفية**: حسب الصفحة والأرشفة
- **تصدير Excel**: تحميل البيانات بصيغة Excel
- **إدارة**: أرشفة وحذف الأرقام
- **ترقيم صفحات**: لسهولة التصفح
- **تصميم احترافي**: واجهة سهلة الاستخدام

## خطوات التفعيل

### 1. تحديث قاعدة البيانات

قم بتشغيل الأوامر التالية:

```bash
# توليد Prisma Client
npx prisma generate

# إنشاء migration
npx prisma migrate dev --name add_phone_numbers_table

# أو تطبيق التغييرات مباشرة
npx prisma db push
```

### 2. إضافة النافذة المنبثقة لباقي صفحات المبيعات

تم إضافة النافذة لصفحة sales1 كمثال. لإضافتها لباقي الصفحات:

#### في كل صفحة sales (sales2, sales3, ... sales11):

1. أضف import في أعلى الملف:
```typescript
import PhoneNumberPopup from '@/components/PhoneNumberPopup'
```

2. أضف المكون قبل إغلاق div الرئيسي:
```typescript
{/* نافذة منبثقة لجمع أرقام الهواتف */}
<PhoneNumberPopup 
  salesPageId="sales2"  // غيّر الرقم حسب الصفحة
  delaySeconds={8}      // التأخير بالثواني
  expiryDays={7}        // عدد الأيام قبل إعادة العرض
/>
```

### مثال كامل (sales2):

```typescript
// في نهاية ملف src/app/sales2/page.tsx
import PhoneNumberPopup from '@/components/PhoneNumberPopup'

// ... باقي الكود

return (
  <>
    {/* المحتوى الحالي */}
    <div className="...">
      {/* ... */}
      
      {/* نافذة منبثقة لجمع أرقام الهواتف */}
      <PhoneNumberPopup salesPageId="sales2" delaySeconds={8} expiryDays={7} />
    </div>
  </>
)
```

### 3. تخصيص الإعدادات

يمكنك تخصيص المعاملات التالية في المكون:

```typescript
<PhoneNumberPopup 
  salesPageId="sales1"    // معرف الصفحة (مطلوب)
  delaySeconds={8}        // الوقت قبل العرض (اختياري، الافتراضي: 5 ثواني)
  expiryDays={7}          // مدة عدم العرض بعد الإرسال (اختياري، الافتراضي: 7 أيام)
/>
```

## الوصول إلى لوحة التحكم

1. قم بتسجيل الدخول كـ Admin
2. من القائمة الجانبية، اختر **"أرقام الهواتف المجمعة"**
3. ستجد:
   - بطاقات إحصائية لكل صفحة مبيعات
   - جدول بكل الأرقام المسجلة
   - أدوات للتصفية والأرشفة والتصدير

## واجهات API

### حفظ رقم هاتف
```
POST /api/phone-numbers/save
Body: {
  phoneNumber: string,
  salesPageId: string,
  source?: string,
  notes?: string
}
```

### جلب الأرقام
```
GET /api/phone-numbers/list
Query Parameters:
  - salesPageId: string (ALL أو sales1, sales2, إلخ)
  - isArchived: boolean
  - page: number
  - limit: number
```

### أرشفة/إلغاء الأرشفة
```
PATCH /api/phone-numbers/list
Body: {
  id: number,
  isArchived: boolean
}
```

### حذف رقم
```
DELETE /api/phone-numbers/list?id={id}
```

## البيانات المحفوظة

### جدول phone_numbers:
- **id**: معرف فريد
- **phoneNumber**: رقم الهاتف
- **salesPageId**: الصفحة المصدر
- **source**: مصدر الزيارة (google, facebook, direct, إلخ)
- **ipAddress**: عنوان IP
- **userAgent**: معلومات المتصفح
- **deviceType**: MOBILE أو DESKTOP
- **country**: الدولة
- **city**: المدينة
- **notes**: ملاحظات إضافية
- **isArchived**: حالة الأرشفة
- **createdAt**: تاريخ الإنشاء

## ملاحظات مهمة

1. **الخصوصية**: يتم تشفير وحماية جميع البيانات
2. **الأداء**: النافذة خفيفة ولا تؤثر على سرعة الصفحة
3. **التوافق**: تعمل على جميع الأجهزة والمتصفحات
4. **الإحصائيات**: يتم تحديث الإحصائيات تلقائياً
5. **التصدير**: يمكن تصدير البيانات إلى Excel بنقرة واحدة

## استكشاف الأخطاء

### المشكلة: لا تظهر النافذة المنبثقة
- تأكد من إضافة المكون في الصفحة
- تأكد من عدم وجود أخطاء في Console
- امسح localStorage وحدّث الصفحة

### المشكلة: خطأ في حفظ البيانات
- تأكد من تشغيل `prisma generate`
- تأكد من تطبيق migration
- راجع logs الخادم

### المشكلة: لا تظهر الصفحة في Dashboard
- تأكد من تسجيل الدخول كـ Admin
- امسح cache المتصفح
- راجع ملف app-sidebar.tsx

## التطوير المستقبلي

يمكن إضافة:
- إرسال رسائل SMS تلقائية
- تكامل مع CRM
- تقارير تحليلية متقدمة
- إشعارات عند ورود رقم جديد
- تصنيفات وعلامات للأرقام
- نظام متابعة العملاء

---

**تم التطوير بنجاح! ✅**

الميزة جاهزة للاستخدام. قم بتطبيق migration وإضافة المكون لباقي صفحات المبيعات.
