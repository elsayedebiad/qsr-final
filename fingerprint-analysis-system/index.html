<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="نظام تحليل حضور احترافي وشامل للموارد البشرية">
    <title>نظام تحليل الحضور المتقدم | HR Portal</title>
    
    <!-- External CSS Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- External JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="p-0">

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 left-4 z-50 space-y-2" style="left: auto; right: 1rem;"></div>

    <div class="flex min-h-screen main-container">
        
        <!-- Sidebar -->
        <aside class="sidebar p-6 flex flex-col hide-on-print">
            
            <div class="text-3xl font-extrabold text-blue-400 mb-8 border-b border-gray-700 pb-3">
                <i class="fas fa-user-clock ml-2"></i>
                HR Portal
            </div>

            <nav class="space-y-2 mb-8">
                <a href="#" class="nav-link active flex items-center p-3 font-semibold" data-target="dashboard" onclick="changeView('dashboard', this)">
                    <i class="fas fa-chart-line ml-3"></i>
                    لوحة القيادة والملخص
                </a>
                <a href="#" class="nav-link flex items-center p-3 font-semibold" data-target="dailyReport" onclick="changeView('dailyReport', this)">
                    <i class="fas fa-calendar-day ml-3"></i>
                    التقرير اليومي المفصل
                </a>
                <a href="#" class="nav-link flex items-center p-3 font-semibold" data-target="charts" onclick="changeView('charts', this)">
                    <i class="fas fa-chart-bar ml-3"></i>
                    الرسوم البيانية والإحصائيات
                </a>
                <a href="#" class="nav-link flex items-center p-3 font-semibold" data-target="employees" onclick="changeView('employees', this)">
                    <i class="fas fa-users ml-3"></i>
                    إدارة الموظفين
                </a>
            </nav>

            <div class="space-y-6 flex-grow overflow-y-auto">
                <h3 class="text-lg font-bold text-gray-400 border-b border-gray-700 pb-2 mb-4">الإعدادات والتحليل</h3>

                <div class="p-3 bg-gray-700 rounded-lg shadow-inner space-y-3">
                    <h4 class="text-md font-semibold text-gray-200">1. ملف الحضور (.dat)</h4>
                    <input type="file" id="attendanceFile" accept=".csv, .dat, .txt" class="hidden" onchange="handleFileUpload('attendance', 'attendanceFile')">
                    <label for="attendanceFile" class="file-input-label flex items-center justify-center space-x-2 space-x-reverse bg-indigo-600 text-white font-bold py-2 px-4 text-sm hover:bg-indigo-700 transition duration-300">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>رفع ملف الحضور</span>
                    </label>
                    <p id="attendanceStatus" class="mt-2 text-xs text-green-400 font-medium"></p>
                    <div id="attendanceError" class="hidden text-xs text-red-400 bg-red-900/50 p-1 rounded mt-1"></div>
                </div>

                <div class="p-3 bg-gray-700 rounded-lg shadow-inner space-y-3">
                    <h4 class="text-md font-semibold text-gray-200 mb-2">2. معايير الحساب</h4>
                    
                    <div class="p-3 bg-blue-900/20 rounded text-sm text-blue-300">
                        <i class="fas fa-info-circle ml-1"></i>
                        <strong>ملاحظة:</strong> يتم حساب صافي الساعات من أول دخول لآخر خروج بدون خصم استراحة
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="analyzeButton" onclick="startAnalysis()" class="w-full bg-blue-500 text-white font-extrabold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chart-line ml-2"></i>
                        بدء التحليل
                    </button>
                </div>

                <div class="mt-4">
                    <button onclick="clearData()" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition duration-300">
                        <i class="fas fa-trash ml-2"></i>
                        مسح البيانات
                    </button>
                </div>

            </div>
            
            <footer class="mt-auto pt-4 border-t border-gray-700 text-xs text-gray-500 text-center">
                <p>تطبيق HR Portal v2.0</p>
                <p>تحليل بالذكاء الاصطناعي (Gemini)</p>
                <p class="mt-2">
                    <i class="fas fa-save"></i> 
                    <span id="autoSaveStatus">حفظ تلقائي نشط</span>
                </p>
            </footer>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            
            <div class="main-content p-6 md:p-10">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-8 border-b pb-3 hide-on-print">
                    <i class="fas fa-briefcase ml-2"></i>
                    إدارة وتحليل بيانات الحضور
                </h1>
                
                <!-- Print Header -->
                <div id="printHeader" class="hidden">
                    <div id="printCompanyHeader" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <img src="mallah.jpg" alt="ELMALLAH Logo" id="printCompanyLogoImg" style="width: 60px; height: 60px; object-fit: contain; display: none;">
                        <div>
                            <div id="printCompanyLogo">ELMALLAH</div>
                        </div>
                        </div>
                        <div id="printCompanyInfo" style="display: none;">
                            <div><strong>Tel:</strong> +20 XXX XXX XXXX</div>
                            <div><strong>Email:</strong> info@elmallah.com</div>
                            <div><strong>Web:</strong> www.elmallah.com</div>
                        </div>
                    </div>
                    
                    <h1 id="printTitle">تقرير سجلات الحضور والانصراف</h1>
                    
                    <div id="printMetadata"></div>
                    <div id="printSummaryBox"></div>
                </div>

                <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center text-indigo-600 font-semibold p-6 bg-indigo-100 rounded-xl shadow-lg mb-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-3"></div>
                    <span id="statusMessage">جارٍ حساب ساعات العمل...</span>
                </div>
                
                <div id="errorMessage" class="hidden text-center text-red-600 bg-red-100 p-4 rounded-xl w-full max-w-lg mx-auto shadow-md mb-8"></div>

                <div id="contentArea">
                    <!-- Dashboard View -->
                    <div id="dashboardView">
                        <div id="summarySection" class="hidden">
                            <h2 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2">
                                <i class="fas fa-tachometer-alt ml-2"></i>
                                لوحة القيادة (Dashboard)
                            </h2>
                            
                            <div class="flex space-x-4 space-x-reverse mb-6 hide-on-print">
                                <div class="flex-1">
                                    <label for="filterMonth" class="block text-sm font-medium text-gray-700">الشهر:</label>
                                    <select id="filterMonth" onchange="filterDataByDate()" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></select>
                                </div>
                                <div class="flex-1">
                                    <label for="filterYear" class="block text-sm font-medium text-gray-700">السنة:</label>
                                    <select id="filterYear" onchange="filterDataByDate()" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></select>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-10">
                                
                                <div class="p-6 bg-white rounded-xl shadow-lg border-b-4 border-indigo-500 stat-card">
                                    <div class="flex items-center justify-center text-indigo-500 mb-3">
                                        <i class="fas fa-users text-4xl"></i>
                                    </div>
                                    <p class="text-sm font-medium text-gray-500 uppercase">إجمالي الموظفين</p>
                                    <p class="text-4xl font-extrabold text-indigo-600 mt-2" id="totalEmployees">0</p>
                                </div>
                                
                                <div class="p-6 bg-white rounded-xl shadow-lg border-b-4 border-purple-500 stat-card">
                                    <div class="flex items-center justify-center text-purple-500 mb-3">
                                        <i class="fas fa-calendar-check text-4xl"></i>
                                    </div>
                                    <p class="text-sm font-medium text-gray-500 uppercase">إجمالي أيام العمل (شامل الغياب)</p>
                                    <p class="text-4xl font-extrabold text-purple-600 mt-2" id="totalWorkDays">0</p>
                                    <p class="text-xs text-gray-500 mt-2">أيام العمل × عدد الموظفين</p>
                                </div>
                                
                                <div class="p-6 bg-white rounded-xl shadow-lg border-b-4 border-green-500 stat-card">
                                    <div class="flex items-center justify-center text-green-500 mb-3">
                                        <i class="fas fa-clock text-4xl"></i>
                                    </div>
                                    <p class="text-sm font-medium text-gray-500 uppercase">متوسط العمل اليومي (للمنشأة)</p>
                                    <p class="text-3xl font-extrabold text-green-600 mt-2" id="avgDailyWorkCompany">0 س و 0 د</p>
                                </div>
                            </div>

                            <div id="monthlyReportFilter" class="hidden mt-10">
                                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b pb-2">
                                    <i class="fas fa-user-check ml-2"></i>
                                    ملخص الأداء الشهري لكل موظف
                                </h2>
                                <div class="mb-4">
                                    <label for="employeeMonthlyFilter" class="block text-sm font-medium text-gray-700">اختر موظفاً لعرض إجمالي ساعات عمله الشهرية:</label>
                                    <select id="employeeMonthlyFilter" onchange="renderMonthlySummary()" class="mt-1 block w-full md:w-1/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></select>
                                </div>
                                
                                <div id="monthlySummaryContainer" class="p-6 bg-white border border-gray-200 rounded-xl shadow-xl">
                                    <p id="monthlySummaryContent" class="text-gray-500 text-center">يرجى اختيار موظف من القائمة أعلاه لعرض الملخص.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Report View -->
                    <div id="dailyReportView" class="hidden">
                        <div id="resultsTableContainer" class="hidden">
                            <h2 class="text-2xl font-extrabold text-gray-800 mb-4" id="dailyReportTitle">
                                <i class="fas fa-file-alt ml-2"></i>
                                تفاصيل سجلات العمل اليومية (جميع السجلات)
                            </h2>
                            
                            <!-- Total Hours Summary for Filtered Employee -->
                            <div id="selectedUserTotalHours" class="mb-4 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500 hidden">
                                <p class="text-lg font-bold text-gray-700 mb-2" id="userNameText"></p>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">إجمالي الساعات:</span>
                                        <span class="font-bold text-blue-600" id="userTotalHoursText"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">أيام العمل:</span>
                                        <span class="font-bold text-green-600" id="userWorkDaysText">0</span>
                                        <span class="text-gray-600"> / غياب:</span>
                                        <span class="font-bold text-red-600" id="userAbsentDaysText">0</span>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle ml-1"></i>
                                    أيام الغياب تظهر في الجدول بلون أحمر
                                </p>
                            </div>

                            <div class="flex flex-col md:flex-row gap-4 mb-4">
                                <div class="flex-1 hide-on-print">
                                    <label for="employeeDailyFilter" class="block text-sm font-medium text-gray-700">تصفية حسب ID الموظف:</label>
                                    <select id="employeeDailyFilter" onchange="filterDailyTable()" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></select>
                                </div>
                                <div class="flex-1 hide-on-print">
                                    <label for="dateDailyFilter" class="block text-sm font-medium text-gray-700">تصفية حسب التاريخ:</label>
                                    <input type="date" id="dateDailyFilter" onchange="filterDailyTable()" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                </div>
                                <div class="flex flex-col space-y-2 hide-on-print">
                                    <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">
                                        <i class="fas fa-file-csv ml-2"></i>
                                        تصدير CSV
                                    </button>
                                    <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">
                                        <i class="fas fa-file-excel ml-2"></i>
                                        تصدير Excel
                                    </button>
                                    <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">
                                        <i class="fas fa-file-pdf ml-2"></i>
                                        تصدير PDF
                                    </button>
                                    <button onclick="handlePrint()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">
                                        <i class="fas fa-print ml-2"></i>
                                        طباعة
                                    </button>
                                </div>
                            </div>

                            <div class="print-table-header hidden" style="display: none;">
                                📋 تفاصيل السجلات اليومية
                            </div>
                            
                            <div class="overflow-x-auto rounded-lg shadow-xl border border-gray-100">
                                <table class="min-w-full divide-y divide-gray-200" id="resultsTable">
                                    <thead class="bg-blue-600">
                                        <tr>
                                            <th class="px-4 py-3 text-right text-sm font-bold text-white" style="background-color: #3b82f6;">ID</th>
                                            <th class="px-4 py-3 text-right text-sm font-bold text-white" style="background-color: #3b82f6;">اسم الموظف</th>
                                            <th class="px-4 py-3 text-right text-sm font-bold text-white" style="background-color: #3b82f6;">التاريخ</th>
                                            <th class="px-4 py-3 text-right text-sm font-bold text-white" style="background-color: #3b82f6;">اليوم</th>
                                            <th class="px-4 py-3 text-right text-sm font-bold text-white" style="background-color: #3b82f6;">دخول</th>
                                            <th class="px-4 py-3 text-right text-sm font-bold text-white" style="background-color: #3b82f6;">خروج</th>
                                            <th class="px-4 py-3 text-right text-sm font-bold text-white" style="background-color: #3b82f6;">صافي الساعات</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-100" id="resultsTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Print Footer -->
                            <div id="printFooter" class="hidden">
                                <div class="print-footer-grid">
                                    <div class="print-footer-section">
                                        <div class="print-footer-title">📊 ملاحظات التقرير</div>
                                        <div class="print-footer-text">
                                            • تم حساب صافي ساعات العمل من أول دخول لآخر خروج<br>
                                            • أيام العطلات (الجمعة) موضحة بلون مميز<br>
                                            • أيام الغياب مشار إليها بوضوح في الجدول
                                        </div>
                                    </div>
                                    <div class="print-footer-section">
                                        <div class="print-footer-title">ℹ️ معلومات التقرير</div>
                                        <div class="print-footer-text" id="printReportInfo">
                                            • تاريخ الإنشاء: <span id="printDate"></span><br>
                                            • النظام: ELMALLAH HR System v2.0<br>
                                            • نوع التقرير: تقرير حضور شامل
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="print-copyright">
                                    تم إنشاء هذا النظام بواسطة engelsayedebaid | © 2024 ELMALLAH
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts View -->
                    <div id="chartsView" class="hidden">
                        <h2 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2">
                            <i class="fas fa-chart-pie ml-2"></i>
                            الرسوم البيانية والإحصائيات
                        </h2>
                        
                        <div id="chartsNotice" class="mb-6 p-4 bg-blue-50 border-r-4 border-blue-500 rounded-lg">
                            <p class="text-blue-700">
                                <i class="fas fa-info-circle ml-2"></i>
                                <strong>ملاحظة:</strong> يتم تحديث الرسوم البيانية تلقائياً عند تحليل البيانات
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">توزيع ساعات العمل حسب الموظف</h3>
                                <div class="chart-container" style="position: relative; height: 350px;">
                                    <canvas id="employeeHoursChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">الالتزام بالهدف اليومي</h3>
                                <div class="chart-container" style="position: relative; height: 350px;">
                                    <canvas id="kpiChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">اتجاه الحضور عبر الزمن</h3>
                                <div class="chart-container" style="position: relative; height: 350px;">
                                    <canvas id="attendanceTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employees Management View -->
                    <div id="employeesView" class="hidden">
                        <h2 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2">
                            <i class="fas fa-users-cog ml-2"></i>
                            إدارة الموظفين
                        </h2>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">إضافة/تعديل أسماء الموظفين</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">رقم ID الموظف:</label>
                                    <input type="text" id="employeeIdInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="مثال: 1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم الموظف:</label>
                                    <input type="text" id="employeeNameInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="مثال: أحمد">
                                </div>
                            </div>
                            <button onclick="addOrUpdateEmployee()" class="mt-4 bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-save ml-2"></i>
                                حفظ الموظف
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">قائمة الموظفين الحالية</h3>
                            <div id="employeesList" class="space-y-2">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>

    </div>

    <!-- Configuration -->
    <script src="js/config.js"></script>
    
    <!-- Main Application Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/exports.js"></script>
    <script src="js/employees.js"></script>
    <script src="js/app.js"></script>

</body>
</html>

